# 確認テスト生成API 改善指示書

## 背景

確認テスト生成APIの初期実装が完了している（`seras-test-generator/`）。
現在、4つの改善を一括で適用し、テストの学習効果を大幅に引き上げる。

**前提条件**:
- check_points が `question`/`answer` 形式に構造化済み（旧: 文字列 → 新: dict）
- 既存のパースロジック（`parse_check_point`）は不要になる
- 設計書: `docs/design/確認テスト生成API_設計書.md`

## 改善の全体像

4つの改善を同時に行う:

| # | 改善 | 概要 |
|---|------|------|
| 1 | ウォームアップ問題 | テスト冒頭に前提知識の復習問題を出す |
| 2 | 英文問題に着眼点 | 英文の横に「どの知識を使うか」を表示 |
| 3 | セット出題 | 知識確認→英文をノード単位でセットにする |
| 4 | 解答の逆引きガイド | 間違えた時に何を復習すべきかを明示 |

## 改善1: ウォームアップ問題

### 概要
テスト範囲の前提知識（prerequisites）から、check_points を数問抽出してテスト冒頭に出す。

### ロジック
1. 対象セクションの knowledge_nodes を取得
2. 各ノードの prerequisites を再帰走査
3. **対象範囲外の** prerequisites ノードを収集（既存の `collect_prerequisite_guide` と同じ走査）
4. それらのノードの check_points から **2〜4問** を抽出（均等配分）
5. テスト冒頭に「ウォームアップ」セクションとして出題

### レイアウト（問題PDF）
```
■ ウォームアップ（前提知識の復習）

(1) S・V・O・Cそれぞれの品詞は？
    ___________________________________

(2) Mとは何か？
    ___________________________________
```

### レイアウト（解答PDF）
```
■ ウォームアップ 解答

(1) S=名詞、V=動詞、O=名詞、C=形容詞または名詞
    [strc-001: 主要素の定義]
    → はじめの英文読解ドリル p.6
    ※ この知識は今回の範囲の前提です。不安なら先に p.6-7 を復習しましょう。

(2) ...
```

## 改善2: 英文問題に着眼点

### 概要
英文問題の各問に、その英文の `knowledge_tags` から関連する知識ノード名を「着眼点」として表示。

### ロジック
1. 英文の `knowledge_tags` を取得
2. 各タグに対応するノードの `name` を取得
3. 「着眼点」として問題文の下に表示

### レイアウト（問題PDF）
```
(3) The students in the classroom are very noisy.
    着眼点: Mの識別方法 / 形容詞の2つの役割と文型判別への応用

    構造: ___________________________________
    和訳: ___________________________________
          ___________________________________
```

着眼点はノード名をそのまま使う。`knowledge_tags` が `[strc-008, strc-009]` なら:
- strc-008 → "Mの識別方法"
- strc-009 → "形容詞の2つの役割と文型判別への応用"

## 改善3: セット出題（最重要の構造変更）

### 概要
現在の「知識確認をまとめて→英文問題をまとめて」という構成を、**ノード単位のセット出題**に変更する。

### 現在の構成
```
■ 知識確認
(1) 問題A ← strc-007
(2) 問題B ← strc-008
(3) 問題C ← strc-009
...

■ 英文問題
(1) 英文X
(2) 英文Y
...
```

### 新しい構成
```
■ セクション 1: 5文型の意味 [strc-007]

  知識確認:
  (1) 第2文型の意味を全部言って
      ___________________________________

  英文で確認:
  (2) Last night, he gave a cat on the street some food.
      着眼点: 5文型の意味 / Mの識別方法
      構造: ___________________________________
      和訳: ___________________________________
            ___________________________________

■ セクション 2: Mの識別方法 [strc-008]

  知識確認:
  (3) Mになるものを2つ言って
      ___________________________________

  英文で確認:
  (4) The students in the classroom are very noisy.
      着眼点: Mの識別方法 / 形容詞の2つの役割
      構造: ___________________________________
      和訳: ___________________________________
            ___________________________________

...
```

### ロジック変更

`question_selector.py` の出力構造を変更する:

**旧: TestData**
```python
@dataclass
class TestData:
    knowledge_questions: list[KnowledgeQuestion]
    sentence_questions: list[SentenceQuestion]
    prerequisite_guide: list[PrerequisiteGuide]
```

**新: TestData**
```python
@dataclass
class WarmupQuestion:
    """ウォームアップ（前提知識の復習）問題"""
    number: int
    question: str
    answer: str
    node_id: str
    node_name: str
    reference_pages: str
    note: str  # 「この知識は今回の範囲の前提です。不安なら先に p.X を復習しましょう。」

@dataclass
class NodeSection:
    """ノード単位のセット出題"""
    node_id: str
    node_name: str
    reference_pages: str
    knowledge_questions: list[KnowledgeQuestion]  # そのノードのcheck_points問題
    sentence_questions: list[SentenceQuestion]     # そのノードに紐づく英文問題
    review_guide: list[ReviewGuide]                # 改善4: 間違えた時の復習先

@dataclass
class ReviewGuide:
    """解答の逆引きガイド"""
    node_id: str
    node_name: str
    reference_pages: str
    reason: str  # 「Mの識別ができなかった場合」等

@dataclass
class TestData:
    sections_label: str          # "Ch01_01〜Ch01_05"
    generated_at: str
    warmup_questions: list[WarmupQuestion]    # 改善1
    node_sections: list[NodeSection]          # 改善3（2,4を内包）
```

### 選定アルゴリズム変更

1. 対象ノードを取得（既存ロジック）
2. 各ノードから check_points を 1〜2問選出（既存ロジック）
3. **英文をノードに紐付けて選出**（変更点）:
   - 各英文の `knowledge_tags` を見て、対象ノードのうち**最もタグが一致する**ノードに割り当てる
   - 1ノードあたり 0〜1文（ノード数が多い場合は英文なしのノードもある）
   - 英文の総数は 4〜6文を維持
   - `role: practice` 優先（既存ロジック）
   - 英文がないノードは知識確認問題のみのセクションになる

4. **A4 2枚の目安**:
   - ウォームアップ: 2〜4問（約0.3ページ）
   - ノードセクション: 6〜10ノード × (知識1〜2問 + 英文0〜1問) ≒ 1.5ページ
   - 合計: 約2ページ

## 改善4: 解答の逆引きガイド

### 概要
解答PDFの各英文問題に「この問題が解けなかった場合の復習先」を付ける。

### ロジック
1. 英文の `knowledge_tags` に含まれるノードIDを取得
2. 各ノードの `prerequisites` を取得
3. ノード自体 + prerequisites を復習先として表示

### レイアウト（解答PDF）
```
■ セクション 3: 形容詞の2つの役割 [strc-009]

  知識確認 解答:
  (5) 自動的にC
      [strc-009: 形容詞の2つの役割と文型判別への応用]
      → はじめの英文読解ドリル p.8

  英文 解答:
  (6) She looks tired this morning.
      構造: S V C M
      和訳: 今朝、彼女は疲れているように見える。
      tiredは名詞を修飾していない形容詞なのでC...

      この問題が解けなかった場合:
        → strc-009: 形容詞の2つの役割（p.8）を復習
        → strc-001: 主要素の定義（p.6）を復習（前提知識）
```

## check_points の新形式への対応

旧形式（文字列）:
```yaml
check_points:
  - "「Cになれる品詞は？」→「形容詞と名詞」と答えられるか"
```

新形式（dict）:
```yaml
check_points:
  - question: "Cになれる品詞は？"
    answer: "形容詞と名詞"
```

### 対応方法
- `parse_check_point()` 関数を削除（または dict 形式対応に書き換え）
- `models.py` の `CheckPoint` を更新:

```python
@dataclass(frozen=True)
class CheckPoint:
    question: str
    answer: str
```

- `KnowledgeNode.check_points` の型を `list[CheckPoint]` に変更
- `data_loader.py` の読み込みロジックを更新

## 変更対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `app/models.py` | CheckPoint dataclass追加、WarmupQuestion/NodeSection/ReviewGuide/TestData 構造変更 |
| `app/services/data_loader.py` | check_points を dict として読み込み |
| `app/services/question_selector.py` | ウォームアップ選定、ノード単位セット出題、英文のノード紐付け、逆引きガイド生成 |
| `app/services/pdf_generator.py` | 新テンプレート対応 |
| `app/templates/test.html` | ウォームアップ + ノードセクション構造 |
| `app/templates/answer.html` | ノードセクション構造 + 逆引きガイド |
| `app/static/styles.css` | セクション区切りのスタイル追加 |
| `app/routers/test_generator.py` | レスポンスのmetadata更新（必要なら） |
| `tests/` | 全テスト更新 |

## テスト方針

- 既存の59テストは構造変更に伴い大幅書き換え
- 新しいテスト観点:
  - ウォームアップ問題が前提ノードから正しく抽出されるか
  - ノードセクションに英文が正しく紐付くか
  - 英文なしのノードセクションが正しく生成されるか
  - 逆引きガイドに prerequisites が含まれるか
  - A4 2枚の問題数制約が守られるか
  - 新形式 check_points (question/answer dict) が正しく読み込まれるか
- PDF出力のスモークテスト: `1-1~1-5` で生成して目視確認

## 完了条件

1. 全テストがGREEN
2. mypy + ruff パス
3. `1-1~1-5` でPDF生成し、以下を目視確認:
   - ウォームアップ問題が冒頭にある
   - ノード単位でセクション分けされている
   - 英文に着眼点が付いている
   - 解答に逆引きガイドが付いている
   - A4 約2枚に収まっている
4. 生成したPDFをリポジトリの `seras-test-generator/test_output.pdf` と `answer_output.pdf` に保存
