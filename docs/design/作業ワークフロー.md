# 作業ワークフロー

## 原則

- **1セクション完結**: 1セクションの全工程を完了してから次に進む。途中で飛ばさない
- **3段階レビュー**: 自己チェック → 自動バリデーション → Codexレビュー
- **PDF原本照合**: 書き起こしMDだけでなく、必ずPDF画像も確認する
- **進捗の可視化**: manifestファイルで全セクションの状態を管理する

---

## 1. セクション作業フロー（1セクションあたり）

```
┌─────────────────────────────────────────────────────┐
│  Step 1: 原本確認                                     │
│  ├── 書き起こしMDを読む                                │
│  ├── PDF画像を開いて照合（誤字脱字、表の崩れ、記号）    │
│  └── 差異があれば書き起こしMDに注記                     │
├─────────────────────────────────────────────────────┤
│  Step 2: 知識ノード抽出                                │
│  ├── 「始める前に」→ 概念定義ノード                     │
│  ├── 「ポイント」→ 具体的知識ノード                     │
│  ├── 動詞リスト等 → リストノード                       │
│  └── YAMLファイル作成（knowledge/カテゴリ/ID_名前.yaml）│
├─────────────────────────────────────────────────────┤
│  Step 3: 英文データベース作成                           │
│  ├── ドリル1の全英文を登録（英文/和訳/構造/タグ）       │
│  ├── ドリル3の全英文を登録                              │
│  ├── ドリル4の全英文を登録                              │
│  └── PDF画像で英文・和訳の正確性を照合                  │
├─────────────────────────────────────────────────────┤
│  Step 4: セクションマッピング追記                       │
│  ├── mappings/はじめの英文読解ドリル.yaml に追記         │
│  └── prerequisites（前提セクション）を記入              │
├─────────────────────────────────────────────────────┤
│  Step 5: 自動バリデーション実行                         │
│  ├── validate.py を実行                                │
│  └── エラー0件になるまで修正                            │
├─────────────────────────────────────────────────────┤
│  Step 6: Codexレビュー                                 │
│  ├── 作成した知識ノード群をCodexに渡してレビュー依頼     │
│  ├── 「参考書の記述に対してノードに漏れがないか」を確認   │
│  ├── 「knowledge_tagsの妥当性」を確認                   │
│  └── 指摘があれば修正                                  │
├─────────────────────────────────────────────────────┤
│  Step 7: manifest更新 & コミット                       │
│  ├── manifest.yaml の該当セクションを completed に更新   │
│  └── git commit（セクション単位）                      │
└─────────────────────────────────────────────────────┘
```

---

## 2. PDF原本照合のルール

### いつPDFを見るか

| タイミング | 何を確認するか |
|-----------|--------------|
| Step 1（原本確認） | 書き起こしMDとPDF画像の一致。特に表、記号（Ⓢ Ⓥ Ⓞ ▲等）、太字/下線の強調 |
| Step 3（英文登録） | 英文のスペル、和訳の正確性、構造分析記号の正確性 |
| 疑問が生じた時 | 書き起こしMDが不自然な場合は必ずPDF原本で確認 |

### PDFへのアクセス方法

```
PDF原本: /Users/aruohta/dev/seras-english-grammar/pdf/rotated/はじめの英文読解ドリル.pdf
ページ画像: /Users/aruohta/dev/seras-english-grammar/pdf/images/はじめの英文読解ドリル/page_XXX.png
書き起こし: /Users/aruohta/dev/seras-english-grammar/pdf/output/はじめの英文読解ドリル/ChXX_XX_タイトル.md
```

### ページ番号の対応

書き起こしMD内に「---\n**p.XX**\n---」の形式でページ番号が記載されている。
PDF画像のpage_XXX.pngは物理ページ（表紙=001）であるため、
オフセット確認済み: **物理ページ番号 = 参考書ページ番号**（page_006.png = p.6）
ページ1-5は前付（表紙、出版社理念、目次等）。

---

## 3. Codexレビューの方針

### レビュー単位

- **Chapter単位**でCodexレビューを実施（セクションごとだと細かすぎる）
- ただし、1 Chapterが完了するたびに必ず実施

### レビュー観点

Codexには以下の観点でレビューを依頼する:

```
1. 漏れチェック: 参考書の該当セクションに書かれている知識で、
   知識ノードとして登録されていないものはないか？

2. 粒度チェック: 1つのノードに複数の独立した概念が混ざっていないか？
   逆に、細かすぎて統合すべきノードはないか？

3. タグ妥当性: 英文のknowledge_tagsは適切か？
   その英文が本当にそのノードの練習になっているか？

4. 依存関係チェック: prerequisitesが適切か？
   循環依存がないか？

5. 表記一貫性: ID命名規則、カテゴリ名、フィールド名に揺れがないか？
```

### Codexレビューの実施方法

codex skillを使い、以下の情報を渡す:
- 作成した知識ノードYAML群
- 対応する参考書セクションの書き起こしMD
- レビュー観点（上記5項目）

---

## 4. 進捗管理: manifest.yaml

```yaml
# manifest.yaml（プロジェクトルートに配置）

project: はじめの英文読解ドリル
last_updated: 2025-02-06

sections:
  Ch01_00:
    title: 「品詞と文型」を始める前に
    type: introduction
    pages: p.6-7
    status: not_started  # not_started / in_progress / review / completed
    knowledge_nodes_created: 0
    sentences_created: 0
    pdf_verified: false
    codex_reviewed: false
    notes: ""

  Ch01_01:
    title: 5文型と「M」
    type: drill
    pages: p.8-11
    status: not_started
    knowledge_nodes_created: 0
    sentences_created: 0
    pdf_verified: false
    codex_reviewed: false
    notes: ""

  # ... 全39セクション + Exam_01, Exam_02 をここに列挙

summary:
  total_sections: 41
  completed: 0
  in_progress: 0
  not_started: 41
  total_knowledge_nodes: 0
  total_sentences: 0
```

### manifestの更新タイミング

- Step 2完了時: `knowledge_nodes_created` を更新
- Step 3完了時: `sentences_created` を更新
- Step 5完了時: `pdf_verified: true`
- Step 6完了時: `codex_reviewed: true`, `status: completed`
- summaryは各セクション完了時に再計算

---

## 5. 自動バリデーションスクリプト

`scripts/validate.py` を用意し、以下のチェックを自動実行する。

### チェック項目

```
CHECK-01: YAMLの構文チェック（全ファイル）
CHECK-02: 知識ノードの必須フィールド存在確認
  → id, name, category, priority, understanding_goals, check_points
CHECK-03: 英文データの必須フィールド存在確認
  → id, drill, english, japanese, knowledge_tags
CHECK-04: knowledge_tagsが参照するノードIDが実在するか
CHECK-05: knowledge_tagsが空の英文がないか
CHECK-06: 英文が0件の知識ノードがないか（警告レベル）
CHECK-07: セクションマッピングのknowledge_nodesが実在するか
CHECK-08: prerequisitesの循環依存がないか
CHECK-09: ID命名規則の一貫性（prefix-NNN形式）
CHECK-10: manifest.yamlとの整合性（ファイル数とmanifest記載の一致）
```

### 実行タイミング

- 各セクションのStep 5で実行
- Chapter完了時にも全体を通して実行

---

## 6. 作業順序

### Phase 1: 基盤構築（最初にやること）

1. manifest.yaml を全セクション分生成
2. validate.py のスケルトンを作成
3. ディレクトリ構造を作成（knowledge/, sentences/, mappings/, scripts/）
4. PDFページ番号のオフセットを確認

### Phase 2: Ch01（品詞と文型）— 全体の基盤かつパイロット

1. Ch01_00 → Ch01_01 → ... → Ch01_06 を順次処理
2. Ch01完了時にCodexレビュー
3. **パイロット完了後、ワークフロー自体を振り返って改善**

### Phase 3: Ch03-04（句と節 + 形容詞・副詞）— 中核

### Phase 4: Ch02（動詞の型）

### Phase 5: Ch05-06（準動詞の主語 + その他重要事項）

### Phase 6: Exam_01, Exam_02（入試演習）

---

## 7. コミット規約

```
# セクション単位のコミット
feat(knowledge): Ch01_00 知識ノード6件作成
feat(sentences): Ch01_01 英文15件登録
feat(mappings): Ch01_01 セクションマッピング追加

# バリデーション修正
fix(knowledge): Ch01_02 knowledge_tags不整合を修正

# レビュー反映
refactor(knowledge): Ch01 Codexレビュー反映

# インフラ
chore: validate.py 初期構築
chore: manifest.yaml 初期生成
```

---

## 8. 品質劣化の防止策まとめ

| リスク | 対策 |
|-------|------|
| 書き起こしMDの誤りをそのまま転記 | PDF画像との照合を必須化 |
| 知識ノードの漏れ | 自動バリデーション（CHECK-05, 06）+ Codexレビュー |
| タグ付けの雑さ | Codexレビュー + CHECK-04（実在確認） |
| 後半のセクションで手抜き | manifest.yamlで全セクション同じ項目をチェック |
| 一貫性の喪失 | CHECK-09（ID命名規則）+ Codexの表記一貫性チェック |
| 依存関係の矛盾 | CHECK-08（循環依存検出） |
| 「あとでやる」の放置 | manifestのstatus管理 + セクション完結原則 |
