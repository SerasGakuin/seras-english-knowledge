# 作業ログ: 「はじめの英文読解ドリル」構造化トライアル

## この作業の位置づけ

「はじめの英文読解ドリル」1冊を使い、知識ノード・英文DB・マッピングの3レイヤー構造で参考書を構造化するワークフローを**試作・検証**した。ここで作成した知識ノードは仮のもので、最終的な知識体系（参考書横断の標準体系）は別途設計する必要がある。

今回の目的は：
- 3レイヤー構造が実際に機能するか確かめる
- 1冊を通して作業すると何がわかるか（工数、品質管理、ノード粒度の傾向）
- ワークフロー（PDF照合、バリデーション、Codexレビュー）の有効性を確認する

---

## 作業の全体像

| Phase | 内容 | 期間 |
|-------|------|------|
| Phase 1 | 基盤構築（ディレクトリ、manifest、validate.py） | 2026-02-11 |
| Phase 2 | Ch01パイロット（品詞と文型） | 2026-02-11 |
| Phase 3 | Ch02〜Ch06 並列構造化 | 2026-02-11〜12 |

### 最終成果

| 指標 | 数値 |
|------|------|
| 知識ノード | 84件（5カテゴリ）※粒度調整後 |
| 英文DB | 498文（32ファイル） |
| 完了セクション | 39/41（Exam 2件を除く全セクション） |
| カテゴリ | 品詞と文型(strc) / 動詞の型(vtyp) / 句と節(clau) / 準動詞の意味上の主語(subj) / 読解テクニック(read) |

---

## Phase 1: 基盤構築

- ディレクトリ構成（knowledge/, sentences/, mappings/, scripts/）を作成
- manifest.yaml に全41セクションを登録
- validate.py を作成（CHECK-01〜10の自動バリデーション）
- 設計ドキュメント（構造化設計案、作業ワークフロー）を策定

設計段階では全体で約131ノードと推定していた。

---

## Phase 2: Ch01パイロット（品詞と文型）

1名のワーカーがCh01（7セクション）を逐次処理。

### 成果
- 知識ノード: 15件（strc-001〜015）
- 英文DB: 93文（6ファイル）

### 教訓

1. **推定ノード数は過大になる**: 設計案26ノード → 実際15ノード（58%）。「概念の独立性」ベースで統合されるため、セクション数＝ノード数にはならない
2. **prerequisites は最初から設定すべき**: Codexレビュー後に追加が多発した。最初から知識ノードID参照で入れるルールに変更
3. **PDF照合は必須**: 2件の書き起こしMD誤りを発見（形容詞句/副詞句の混同）。MDだけで作業すると誤りがそのまま転記される
4. **validate.py --section に問題**: 知識ノードのパスにChapter名を含まないためフィルタが効かない → 全体実行に変更
5. **一括報告が効率的**: セクションごとの報告は冗長。Chapter完了後に1回まとめて報告する方式に変更

---

## Phase 3: Ch02〜Ch06 並列構造化

Phase 2の教訓を反映し、3名のワーカーを並列に走らせて残り全Chapterを一気に構造化した。

### チーム構成

```
            team-lead
            ├── スポットチェック
            ├── マッピング一元書き込み
            ├── manifest一元更新
            └── git commit
                 │
     ┌───────────┼───────────┐
     │           │           │
 worker-a    worker-b    worker-c
 Ch03+Ch04   Ch02        Ch05+Ch06
 clau-*      vtyp-*      subj-* / read-*
```

### ID帯域配分

| ワーカー | Chapter | prefix | 割当帯域 | 実使用 |
|---------|---------|--------|---------|-------|
| worker-a | Ch03 | clau | 001〜025 | 001〜008 |
| worker-a | Ch04 | clau | 026〜055 | 026〜033 |
| worker-b | Ch02 | vtyp | 001〜040 | 001〜021 |
| worker-c | Ch05 | subj | 001〜015 | 001〜005 |
| worker-c | Ch06 | read | 001〜035 | 001〜014 |

Phase 2の実績（推定の58%）を踏まえ余裕を持って帯域を割り当てたが、さらに少なく済んだ。

### Chapter別の実績

| Chapter | テーマ | ノード数 | 英文数 | セクション数 |
|---------|--------|---------|-------|------------|
| Ch01 | 品詞と文型 | 15 | 93 | 7 |
| Ch02 | 動詞の型 | 21 | 120 | 9 |
| Ch03 | 名詞のカタマリ | 8 | 75 | 6 |
| Ch04 | 形容詞・副詞のカタマリ | 8 | 90 | 7 |
| Ch05 | 準動詞の意味上の主語 | 5 | 30 | 3 |
| Ch06 | その他の重要事項 | 14 | 90 | 7 |
| **合計** | | **71** | **498** | **39** |

### 推定 vs 実績

設計案での推定ノード数は131。実際は71（54%）。概念の独立性ベースで統合すると、1セクション1ノードに収束するケースが多かった。Ch02（動詞の型）は動詞リストが多く21ノードと最多。Ch05は3セクションのため5ノードと最少。

### Cross-Chapter prerequisites調整

Ch05（準動詞の意味上の主語）は本来Ch03/Ch04（句と節）の知識が前提だが、並列作業のため作成時にはclau-*を参照できなかった。Phase 3の最後にリーダーが以下の調整を実施:
- subj-001 ← clau-001（句と節の定義）
- subj-002 ← clau-032（副詞句・分詞構文）
- subj-003 ← clau-004, clau-028, clau-031（名詞句、形容詞句、副詞句）
- subj-004 ← clau-004（名詞句＝動名詞含む）
- subj-005 ← clau-032（副詞句・分詞構文）

---

## 品質管理の仕組みと有効性

### 品質ゲート

| ゲート | 内容 | 誰が | いつ | 有効だったか |
|-------|------|------|------|------------|
| PDF照合 | 書き起こしMDとPDF画像の照合 | ワーカー | 各セクション | Ch01で2件の誤り発見。以降はMDの品質が高く差異なし |
| validate.py | 自動バリデーション（10項目） | ワーカー | 各セクション | 構文エラー・ID不整合・循環依存を即座に検出。必須 |
| 品質チェックリスト | 6項目の手動確認 | ワーカー | 各セクション | understanding_goals/check_pointsの具体性を担保 |
| Codexレビュー | 5観点の外部レビュー | ワーカー | Chapter完了時 | タグ妥当性の改善提案あり（Ch02でknowledge_tagsの複合タグ追加） |
| スポットチェック | ノード1-2件+英文DB1セクションをサンプル確認 | リーダー | 完了報告受信時 | 品質の均一性を確認 |

### validate.py --section の問題

知識ノードのパスが `knowledge/品詞と文型/strc-001_xxx.yaml` のように Chapter名を含まないため、`--section Ch03` でフィルタすると知識ノード側のバリデーションがスキップされる。対策として引数なし（全体実行）に統一した。Ch01完了済みデータも検証対象になるがエラーは出ないので問題なし。

---

## コミット履歴

```
c07186f feat: Ch01（品詞と文型）構造化完了 — 知識ノード15件・英文93件
36811d2 feat: Ch02（動詞の型）構造化完了 — 知識ノード21件・英文120件
eb2ba80 feat: Ch03（名詞のカタマリ）構造化完了 — 知識ノード8件・英文75件
5b81a53 feat: Ch04（形容詞・副詞のカタマリ）構造化完了 — 知識ノード8件・英文90件
dfe2be0 feat: Ch05（準動詞の意味上の主語）構造化完了 — 知識ノード5件・英文30件
2536987 feat: Ch06（その他の重要事項）構造化完了 — 知識ノード14件・英文90件
73f7d20 feat: Phase 3 マッピング統合 + manifest更新（Ch02〜Ch06）
558d7d7 fix: Cross-Chapter prerequisites調整 — Ch05ノードにclau-*参照を追加
```

---

## 残作業

- **Exam_01, Exam_02**（入試実戦演習、p.152-159）: 未着手。これらは知識ノードを新規作成するのではなく、既存ノードへのknowledge_tagsのみで構成される想定
- **参考書横断の標準知識体系の設計**: 今回のノードは「はじめの英文読解ドリル」1冊に閉じた仮のもの。核心・成川等の文法参考書と統合するには、参考書に依存しない「あるべき知識体系」を別途設計する必要がある

---

## 所感・今後に活かすこと

### 3レイヤー構造について
- knowledge（知識ノード）/ sentences（英文DB）/ mappings（セクションマッピング）の分離は機能した。知識ノードを参考書のセクション構造から独立させることで、将来的な参考書横断マッピングの土台にできる
- ただし今回のノードは「はじめの英文読解ドリル」の章立てに沿って作ったため、参考書依存が強い。標準知識体系では粒度や分類が変わる可能性が高い

### ノード粒度の傾向

設計段階の推定（131ノード）に対し実績71ノード（54%）。ただし「適切に統合された結果」とは言い切れず、**Chapter間で粒度の一貫性が崩れている**。

#### Chapter間の粒度比較

| Chapter | 設計推定 | 実績 | 比率 | ドリルセクション数 | ノード/セクション | 調整後 |
|---------|---------|------|------|------------------|-----------------|--------|
| Ch01 品詞と文型 | 26 | 15 | 58% | 6 | **2.5** | — |
| Ch02 動詞の型 | 31 | 21 | 68% | 8 | **2.6** | — |
| Ch03 名詞のカタマリ | 18 | 8 | 44% | 5 | ~~1.6~~ | **2.0** |
| Ch04 形容詞・副詞のカタマリ | 22 | 8 | 36% | 6 | ~~1.3~~ | **2.33** |
| Ch05 準動詞の意味上の主語 | 10 | 5 | 50% | 2 | **2.5** | — |
| Ch06 その他の重要事項 | 24 | 14 | 58% | 6 | **2.3** | — |

~~Ch01/02/05/06は1セクションあたり2〜3ノードだが、Ch03/04はほぼ1セクション=1ノードに潰れている。~~ → 粒度調整により全Chapter 2.0以上に統一された。

#### 具体例: 粒度の差

- **Ch01_01**（5文型とM）→ 3ポイント → **3ノード**（strc-007, 008, 009）
- **Ch04_04**（副詞句_不定詞）→ 5ポイント → **1ノード**（clau-031）

Ch04_04は5つの訳出パターン（目的/結果/感情の理由/判断の根拠/程度）を1ノードに詰め込んでおり、check_points 4問で全カバーするには無理がある。

#### 原因

「概念の独立性ベースで統合してよい」というルールが、ワーカーによって解釈が異なった。

- worker-b（Ch02）: リストノードを個別に切り出す → 1セクション2〜3ノード
- worker-a（Ch03+Ch04）: セクション≒ノードの1:1対応 → 粒度が粗い
- worker-c（Ch05+Ch06）: Ch01に近い粒度 → 1セクション2〜3ノード

#### トライアルとしての評価

今回は「仮の知識ノード」であり粒度最適化は目的外のため、**許容範囲**。英文DBとマッピングは正確に作られており、ノード再分割時に再利用可能。

#### 粒度調整の実施（2026-02-12）

上記の粒度一貫性問題を解消するため、Ch03/Ch04のノード分割を実施した。

**分割基準**:
- 独立テスト可能性: そのポイントだけを「問い→答え」でテストできるか
- 部分的習得の可能性: 一方は習得済みで他方は未習得という状態がありうるか
- 分割後の英文数: 各ノードに3文以上の練習英文を確保できるか

**結果**:

| Chapter | 分割前ノード | 分割後ノード | ノード/セクション |
|---------|------------|------------|-----------------|
| Ch03 drill | 5 | **10** | **2.0** |
| Ch04 drill | 6 | **14** | **2.33** |
| **全体** | 71 | **84** (+13) | — |

**新規ノード一覧**:
- Ch03: clau-009〜013（疑問詞内部役割、whatの二面性、how+形副、whether/if制約、形式目的語）
- Ch04: clau-034〜041（分詞形容詞句、関代省略、関係副詞書換、感情理由/判断根拠、enough/too、分詞構文訳出、so/such...that、接続詞リスト）

**チーム構成**: 3ワーカー並列（worker-a: Ch03, worker-b: Ch04前半, worker-c: Ch04後半）
**品質ゲート**: Codex分割前レビュー → PDF照合 → validate.py → リーダースポットチェック → マッピング統合後validate.py → 被参照ノード整合性確認。全ゲート通過。

#### 標準知識体系への教訓

1. **粒度基準の明文化**: 「1ノードにcheck_points 3〜5問で全知識をテストできるか」を判定基準にする。超えるなら分割
2. **参考比率**: ドリルセクションは概ね1.5〜2.5ノード/セクションが妥当（Ch01/02/06の実績）
3. **ワーカー間の粒度キャリブレーション**: 並列作業前に同一セクションのサンプルを全ワーカーに渡して粒度基準を揃える

その他の傾向:
- 動詞リストなど「一覧」系はリストノードとして独立させると有用（Ch02のvtyp-007〜018のパターン）
- 「始める前に」（introduction）セクションは概念定義ノード群を生むが、英文DBを持たないためorphan警告が出る。これは構造上の想定通り

### ワークフローの効率
- 並列ワーカー構成（3名）は効果的だった。prefix帯域を事前に割り当てることでID衝突を防止し、mappings/manifestはリーダーが一元管理することで競合を回避できた
- Cross-Chapter prerequisites の後処理は並列化の代償。作業順序を厳密に制御すれば不要だが、並列の速度メリットの方が大きい

### 品質管理について
- validate.py による自動バリデーションが最も費用対効果が高い。手動チェックだけでは見逃す構文エラーやID不整合を確実に検出できる
- PDF照合は初回（Ch01）で2件の差異を発見した。以降は差異がなかったが、「確認したから安心」という効果がある。省略すべきでない
- Codexレビューはknowledge_tagsの改善提案で有用だったが、大きな漏れの指摘はなかった。1冊完結の構造化では、セクション単位の作業が丁寧であればChapter単位のレビューで十分

---

## Phase B: check_points 構造化（2026-02-12）

### 背景
check_points は当初、文字列形式で記述されていた（例: `「Cになれる品詞は？」→「形容詞と名詞」と答えられるか`）。正規表現パースが3パターン（A1: 鉤括弧Q→A、A2b: 括弧なし解答、B: 能力記述型）に分かれ、フォールバック処理が複雑だった。

### 変更内容
全84ノードの check_points を文字列形式から dict形式に変換。

```yaml
# 旧形式（文字列）
check_points:
  - "「Cになれる品詞は？」→「形容詞と名詞」と答えられるか"

# 新形式（dict）
check_points:
  - question: "Cになれる品詞は？"
    answer: "形容詞と名詞"
  - assessment: "S・V・O・Cそれぞれの品詞を即答できるか"
```

- `question` + `answer`: 問答形式（旧パターンA1/A2b）
- `assessment`: 能力記述形式（旧パターンB）。解答は understanding_goals から補完

### 結果
- 84ファイル、300→301エントリ変換
- 正規表現パースの廃止。data_loader の `_parse_check_point()` が dict をそのまま CheckPoint に変換
- コミット: `d6c0ca7`

---

## Phase C: 確認テスト生成API 改善（2026-02-12）

### 概要
初期実装のフラット出題構造を、ノード単位セット出題＋4つの改善に再構築した。

### 4つの改善

| # | 改善 | 内容 |
|---|------|------|
| 1 | ウォームアップ問題 | 対象範囲外の前提ノードから round-robin で 2-4問を冒頭に配置 |
| 2 | 着眼点 | 英文問題に focus_points（knowledge_tags のノード名）を表示。どの知識を使うかのヒント |
| 3 | ノード単位セット出題 | 旧フラット構造 → NodeSection（知識確認 max 2問 + 英文 0-1文 + ReviewGuide）に再構成 |
| 4 | 逆引きガイド | ノード別の ReviewGuide。英文の knowledge_tags + prerequisites から復習先を一覧表示 |

### 変更モジュール

| モジュール | 変更内容 |
|-----------|---------|
| `models.py` | WarmupQuestion, NodeSection, ReviewGuide, SentenceQuestion(+focus_points) 追加。旧 PrerequisiteGuide 廃止。TestData を階層構造に |
| `question_selector.py` | `build_test_data()` を中心にほぼ全面書き換え。`select_warmup_questions()`, `_assign_sentences_to_nodes()`, `build_node_sections()`, `_build_review_guide()` を新規実装 |
| `pdf_generator.py` | テンプレート変数を新構造に合わせて更新 |
| `templates/test.html` | ウォームアップ → ノード別セクション（知識確認 + 着眼点付き英文）の構造に |
| `templates/answer.html` | ウォームアップ解答 → ノード別セクション（知識確認解答 + 英文解答 + 逆引きガイド）の構造に |

### テスト結果
- 67件全GREEN
- mypy + ruff パス済

### 改善方針の詳細
- [確認テスト改善指示書](../design/確認テスト改善_指示書.md) を参照

---

## Phase C: デプロイ（2026-02-12）

### 経緯

当初 Railway へのデプロイを予定していたが、Hobby プラン（有料）が必要と判明。GCP Cloud Run に方針転換した。

### GCP セットアップ

| 項目 | 値 |
|------|-----|
| GCP プロジェクト | `seras-test-generator` |
| アカウント | seras.gakuin@gmail.com |
| リージョン | asia-northeast1 |
| サービス | Cloud Run（`seras-test-generator`） |
| PDF 保存先 | GCS（`gs://seras-test-pdfs`、公開バケット） |

### デプロイ時のトラブルと解決

| 問題 | 原因 | 解決 |
|------|------|------|
| Cloud Build 失敗 | `libgdk-pixbuf2.0-0` が Debian Trixie で名称変更 | `libgdk-pixbuf-2.0-0`（ハイフン区切り）に修正 |
| 503 エラー | WeasyPrint の PDF 生成でメモリ不足（512MiB） | `--memory 1Gi` に増設 |
| Drive API エラー | 個人 Gmail のサービスアカウントにはストレージクォータがない | Google Drive → GCS に方針転換 |

### Google Drive → GCS への変更

Google Drive API でサービスアカウント経由でファイルを作成しようとしたところ、「Service Accounts do not have storage quota」エラーが発生。これは個人 Gmail アカウントの根本的な制約で、スコープ変更では解決不可。

GCS に切り替え:
- `gcs_uploader.py` を新規作成（`drive_uploader.py` の代替）
- バケット `gs://seras-test-pdfs` を作成し `allUsers` に `objectViewer` を付与（公開URL）
- `config.py` に `gcs_bucket_name` 設定を追加
- テスト（67件）のモック対象を `DriveUploader` → `GCSUploader` に更新

### Dockerfile 設計

Dockerfile はリポジトリルートに配置。`seras-test-generator/` のアプリコードと、ルートの `knowledge/` `sentences/` `mappings/` の両方を `COPY` する構成。

検討した3案:
1. git submodule（管理が複雑）
2. 手動コピー（CI 時に忘れるリスク）
3. **同一リポジトリから直接 COPY**（採用）

### 動作確認

```
POST https://seras-test-generator-hif2eccama-an.a.run.app/generate-test
{"sections": "1-1~1-3"}
→ 200 OK, PDF URL 2件（テスト用・解答用）返却
```

### 残タスク
- GAS 統合（スプレッドシートから API を呼び出す GAS スクリプト）→ 実運用開始
